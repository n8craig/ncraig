{"title":"Reading and Visualizing GDELT Data","markdown":{"yaml":{"title":"Reading and Visualizing GDELT Data","description":"A quick look at how to incorporate GEDELT visualizations or create ones using `xts` and `dygraphs`.\n","author":"Nathan Craig","date":"2022-10-10","categories":["how-to","GDELT","wrangling"],"editor":"source","format":{"html":{"df-print":"kable","code-fold":true,"code-summary":"Code"}},"bibliography":"references.bib"},"headingText":"Embedding","containsRefs":false,"markdown":"\n\nThe Global Database of Events, Language, and Tone (GDELT) offers a TV News explorer. I've tinkered with using this to look at [themes](https://nmc.quarto.pub/nmc/posts/2021-05-07-critical-race-theory/) like Critical Race Theory and explored a bit how to [access](https://nmc.quarto.pub/nmc/posts/2021-12-09-gdelt-summary-explorer-api-calls-in-r/) GDELT data via api. Previously, I visualized the data using `ggplot2` but recently I began using the `dygraphs` library and thought it might be interesting to apply to GDELT data. Representing GDELT searches using `dygraphs` is the main thing this post looks at. First, let's dig into simply embedding one of the graphs produced by GDELT.\n\n\nGDELT provides nice interactive visualizations and Quarto offers a simple mechanism to [embed](https://quarto.org/docs/authoring/figures.html#figure-divs) such a visualization using `iframe` along with fenced divs. If you just want something quick and dirty, embedding is a fine way to go. However, graph customization is very limited.\n\nIt is worth noting that GDELT TV News search interface offers two output options: Summary Overview Dashboard and Comparison Visualization.\n\n![](https://i.imgur.com/9Zaiq3f.png)\n\nThe Summary Overview Dashboard returns individual station mentions of a single search term. It allows one to see similarities and differences between networks regarding the mention of a specific search term. The Comparison Visualization allows one to look at similarities and differences between search terms where all news networks are merged. Each tells a different story about the data. We will look at both options.\n\n## Output\n\n```{=html}\n<style>\n.respviz { height: 400px; }\n@media screen and (min-width : 0px) and (max-width : 767px){ .respviz { height: 250px; } }\n</style>\n```\n::: {#fig-crt .column-page}\n<iframe src=\"https://api.gdeltproject.org/api/v2/tv/tv?format=html&amp;timespan=FULL&amp;last24=yes&amp;query=%22critical%20race%20theory%22%20(station:CNN%20OR%20station:FOXNEWS%20OR%20station:MSNBC%20)%20&amp;mode=timelinevol&amp;timezoom=yes\" scrolling=\"no\" width=\"100%\" frameborder=\"0\" class=\"respviz\">\n\n</iframe>\n\nCritical Race Theory showing coverage by station.\n:::\n\n::: {#fig-crt-evol .column-page}\n<iframe src=\"https://api.gdeltproject.org/api/v2/summary/summary?d=iatv&amp;t=compare&amp;k1=%22critical+race+theory%22&amp;fs1=station%3ACNN&amp;fs1=station%3AFOXNEWS&amp;fs1=station%3AMSNBC&amp;k2=evolution&amp;fs2=station%3ACNN&amp;fs2=station%3AFOXNEWS&amp;fs2=station%3AMSNBC&amp;fs3=station%3ACNN&amp;fs3=station%3AFOXNEWS&amp;fs3=station%3AMSNBC&amp;fs4=station%3ACNN&amp;fs4=station%3AFOXNEWS&amp;fs4=station%3AMSNBC&amp;fcs=comb&amp;stm=yes&amp;c=1&amp;cvt=embed&amp;ct=timelinemerge\" scrolling=\"yes\" width=\"100%\" frameborder=\"0\" class=\"respviz\">\n\n</iframe>\n\nComparison visualization showing differences and similarities in the coverage of \"Critical Race Theory\" and \"Evolution\" over time.\n:::\n\nNote while @fig-crt and @fig-crt-evol show generally similar trends, the two graphs are not synchronized in any way. To synchronize the two graphs, we'll need to make our own. Before we get into that, let's look at how to embed a visualization generated by GDELT.\n\n## How To Embed\n\nTo get the embed code click on the EXPORT hamburger menu and select \"Embed This Chart\"\n\n![](https://i.imgur.com/Ap9Ekwu.png)\n\nSelect the output text and paste it into a quarto document in source mode.\n\n![](https://i.imgur.com/xauiJBL.png)\n\nThat text needs to be copied and formatted as two separate parts: first there is an `html` chunk containing a `css` class for `.respviz` and then a fenced div containing the `iframe` objects. In the example below, please note that the request URL was shortened for readability.\n\n```` column-page\n\n```{=html}\n\n<style>\n.respviz { height: 400px; }\n@media screen and (min-width : 0px) and (max-width : 767px){ .respviz { height: 250px; } }\n</style>\n\n```\n\n``` column-page\n\n::: {#fig-crt .column-page}\n\n<iframe src=\"<<URL>>\" scrolling=\"no\" width=100% frameborder=\"0\" class=\"respviz\"></iframe>\n\nCritical Race Theory\n\n:::\n````\n\nVoil√†, (with a fully formed URL) this should produce an embedded graph like the ones shown at the top of this page. Now, let's turn to how we can create our own visualizations that can be customized.\n\n# Constructing Visualizations\n\nMaking one's own visualization of the data isn't that much more complicated than embedding, and there is the added benefit of having access to a wider range of customizations.\n\n## Single Search\n\nWe will load the data using `read_csv` and then convert it to a time series for plotting.\n\n```{r libraries}\n#| message: false\n\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(ggplot2)\nlibrary(knitr)\n\n# Time series\nlibrary(xts) # convert df to ts\nlibrary(dygraphs) # plot ts \n```\n\n```{r search-term}\n# paste in the text from the GUI search box.\n# note that entire string should be contained in single quotes\n# this allows for double quoted search terms\nsearch_term <- '\"critical race theory\"'\n```\n\n```{r single-search-read-csv-data}\n#| message: false\n\n# Paste the request URL into a read_csv call and assign to variable\ndf <- read_csv(\"https://api.gdeltproject.org/api/v2/tv/tv?format=csv&timespan=FULL&last24=yes&dateres=DAY&query=%22critical%20race%20theory%22%20(station:BLOOMBERG%20OR%20station:CNBC%20OR%20station:CNN%20OR%20station:CSPAN%20OR%20station:CSPAN2%20OR%20station:CSPAN3%20OR%20station:FBC%20OR%20station:FOXNEWS%20OR%20station:MSNBC%20)%20&mode=timelinevol&timezoom=yes\")  %>% \n  rename(date = 1,\n         network = 2,\n         value = 3) %>% \n  mutate(search = search_term)\nhead(df)\n```\n\nGreat, we have a data frame. However, `dygraphs` wants a time series object. Therefore, this data frame has to be converted to a time series object. Complicating matters is the fact that there are multiple series in \"long\" form.\n\nIn terms of figuring out how to convert a data frame with multiple series to a format that `dygraphs` reads, I initially found Marcelo Avila's Stack Overflow [answer](https://stackoverflow.com/a/68122673/13110995) was helpful; though I don't quite use it in the end. Marcelo's approach involves reading the data frame with `zoo` and then converting it to an `xts` with `as.ts()`. This worked well with the API call, but I found that doesn't work with a `csv` file. With some experimentation, I found that a call to `read.zoo()` worked in both cases and was simpler; so that's what I went with.\n\nIn short: we'll pivot wider and use the `as.ts` function with `read.zoo` to create a time series data structure that `dygraphs` likes.\n\n```{r single-search-pivot-wider}\ndf_wide <- df %>% pivot_wider(names_from = \"network\", values_from = \"value\") %>% \n  select(-search) # we don't want this inside the time series\n\n```\n\n```{r single-search-make-ts}\n# This is from Marcelo Avila's SO answer\n# We can read the data as a zoo object and convert\n# to an xts object. However, dygraphs can read zoo\n# ts <- as.ts(read.zoo(df_wide))\n\nts1 <- read.zoo(df_wide)\n\n# ts <- as.ts(df_wide)\n```\n\nYou can use `head(ts)` to see the data structure. The data will plot with simply `dygraph(ts)` alone, but the visualization looks better with some styling. See the `dygraphs` [reference](https://rstudio.github.io/dygraphs/index.html) for styling and annotation options.\n\n```{r fig-crt-plot}\n#| column: page\n#| fig-cap: GDELT Volume Timeline\n\ndygraph(ts1) |> \n  dyRoller(rollPeriod = 15) |> \n  dyHighlight(highlightCircleSize = 5, \n              highlightSeriesBackgroundAlpha = 0.2,\n              hideOnMouseOut = TRUE) |> \n  dyEvent(\"2011-09-05\", \"Bell Passes          \", labelLoc = \"top\") |> \n  dyEvent(\"2012-03-07\", \"Breitbart Publishes Obama/Bell Video          \", \n          labelLoc = \"top\") |> \n  dyEvent(\"2020-06-25\", \"George Floyd Murdered\", labelLoc = \"bottom\") |> \n  dyEvent(\"2020-09-01\", \"C. Rufo on FOX News\", labelLoc = \"bottom\") |> \n  dyEvent(\"2020-09-22\", \"Trump Signs EO          \", labelLoc = \"top\") |> \n  dyEvent(\"2021-01-20\", \"Biden Sworn In          \", labelLoc = \"top\") |> \n  dyAxis(\"y\", label = \"% Airtime (15s blocks)\") |> \n  dyLegend(width = 850)\n\n\n```\n\n## Comparison Searches\n\nThis works very well when the GDELT search interface Output Type is set to Summary Overview Dashboard. However, when the GDELT search interface Output Type is set to Comparison Visualization, the Export -\\> Save as JSON option is not available. I'm not sure why this is, but if one wants to build a comparison graph, at present, it is necessary to download a `csv` file. We'll do that for a search wereh output type is set to Comparison Visualization.\n\n![](https://i.imgur.com/SWyUKKB.png)\n\nRead this file and convert it to a format that `dygraph` can read. First, we make a data frame.\n\n```{r multi-search-read-data, message=FALSE}\ndf2 <- read_csv(\"crt-evolution-comparison.csv\") |> \n  rename(date = 1,\n         \"Critical Race Theory\" = 2,\n         \"Evolution\" = 3) |> \n  mutate(date = my(date))\n```\n\nI found that reading from a `csv` was different than reading from the API above. To convert the data frame to something `dygraphs` wants, I was initially using `as.ts(read.zoo(df_wide))`. However, when reading from `csv` many of the 0 readings were converted to `NA`. This can be overcome with `z2[is.na(z2)] = 0`. However, if one simply uses `read.zoo()` this isn't necessary. I just used `zoo` which seems to work fine.\n\n```{r multi-search-convert-to-time-series}\n\nts2 <- read.zoo(df2)\n\n```\n\n```{r fig-multi-search-plot}\n#| column: page\n#| fig-cap: GDELT volume timeline comparing mentions of \"Critical Race Theory\" and Evolution\n\ndygraph(ts2) |> \n  dyLegend(width = 500)\n```\n\n## Descriptive Statistics\n\nHaving visualized at the data, there are some questions one might want to ask about their structure. Does one station cover \"Critical Race Theory\" more than another? Is \"Critical Race Theory\" discussed more often than Evolution?\n\n### Does one station cover CRT more often than another?\n\nLet's narrow the question slightly. For the period of time covered by GDELT, are there differences in the average and total coverage of CRT by network? We can begin by generating a few simple descriptive statistics and plotting these.\n\n```{r tbl-crt-summary}\n#| tbl-cap: Summary statistics of CRT coverage by network\n\ndf_crt_summary <- group_by(df, network) |> \n  summarise(\n    sum = sum(value),\n    mean = mean(value),\n    sd = sd(value)\n  )\ndf_crt_summary|> kable(digits =3)\n```\n\n```{r fig-crt-summaries}\n#| column: page\n#| layout-ncol: 3\n#| fig-cap: CRT summary value plots\n#| fig-subcap: \n#|   - \"Average coverage\"\n#|   - \"Average and standard deviation coverage\"\n#|   - \"Sum coverage\"\n\nggplot(df_crt_summary, aes(y=mean, x= network, color=network))+\n  geom_point(aes(size=4))+\n  theme(legend.position = \"none\")\n\nggplot(df_crt_summary, aes(y=mean, x= network, color=network))+\n  geom_point(aes(size=4))+\n  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd))+ \n  theme(legend.position = \"none\")\n\nggplot(df_crt_summary, aes(y=sum, x= network, color=network))+\n  geom_point(aes(size=4))+ \n  theme(legend.position = \"none\")\n```\n\nBased on the average and sum plots, it looks like FOXNEWS reported more frequently on CRT than other networks. The average plot is complicated to read because while FOXNEWS has the hugest average coverage (@fig-crt-summaries-1) when one includes standard deviation the differences are less clear (@fig-crt-summaries-2). This is because of the very large variation in FOXNEWS coverage. Differences in coverage appear clearer when looking at total coverage; here we can see that FOXNEWS covered CRT more than twice as often as any other network (@fig-crt-summaries-3). Intriguingly FBC, which is Fox Business, has the second highest average and second highest total coverage of CRT.\n\n# Is Critical Race Theory covered more often than Evolution?\n\nLooking at @fig-multi-search-plot, it seems as though there are differences in the coverage of CRT and Evolution over time. Generally, Evolution is mentioned more frequently but in 2021 there was a marked increase in mentions of CRT. We can quantify the global differences @tbl-crt-evol-differences.\n\n```{r tbl-crt-evol-differences}\n#| tbl-cap: Summary statistics comparing mentions of CRT and Evolution in the GDELT TV News Archive.\ndf2 |> pivot_longer(2:3, names_to = \"search\", values_to = \"value\") |> \n  group_by(search) |> \n  summarize(\n    sum_norm = (sum(value)/as.numeric(difftime(max(df2$date), min(df2$date), units=\"days\")))*100,\n    mean = mean(value),\n    sd = sd(value)\n  )|> kable(digits =3)\n```\n\nBoth the time normalized sum and mean coverage of Evolution is higher than CRT, but the standard deviation of CRT coverage is much higher than Evolution. This is because of the very high amplitude coverage that occurred in 2021 and continues to early 2022.\n\n```{r tbl-coverage-comparison}\n#| column: page\n#| layout-ncol: 2\n#| tbl-cap: \n#|  - \"Pre-2021 Coverage\"\n#|  - 'Post-2021 Coverage'\n\n# Pre-2021 Coverage\ndf2 |> \n  filter(date < \"2021-01-01\") |> \n  pivot_longer(2:3, names_to = \"search\", values_to = \"value\") |> \n  group_by(search) |> \n  summarize(\n    # Sum is temporally scaled\n    sum_norm = (sum(value)/as.numeric(difftime(\"2021-01-01\", min(df2$date), units=\"days\")))*100,\n    mean = mean(value),\n    sd = sd(value)\n  ) |> kable(digits = 4)\n\n# Post-2021 Coverage\ndf2 |> \n  filter(date > \"2021-01-01\") |> \n  pivot_longer(2:3, names_to = \"search\", values_to = \"value\") |> \n  group_by(search) |> \n  summarize(\n    # Sum is temporally scaled\n    sum_norm = (sum(value)/as.numeric(difftime(max(df2$date),\"2021-01-01\", units=\"days\")))*100,\n    mean = mean(value),\n    sd = sd(value)\n  ) |> kable(digits = 4)\n```\n\nTime series analysis [@kitagawa2020], and time series forecasting [@hyndman2021] are enormous fields that I barely understand. However, I do know that when the pre-event state is low amplitude and low variability for long periods of time, then for the purpose of event analysis the mean and standard deviation of that signal can serve as a predicted counterfactual [@huntington-klein2022]. Therefore, we should be able to compare the before state to the after state based on mean and standard deviation.\n\nThis is useful, but in this case the standard deviation is larger than the mean. This is because the signal is larger but still erratic over time. To talk about accumulated coverage over time, we can use a time normalized sum.\n\n\n\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"kable","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"output-file":"index.html"},"language":{"code-summary":"Code"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.269","editor":"source","theme":"lux","mainfont":"Sorts Mill Goudy","title":"Reading and Visualizing GDELT Data","description":"A quick look at how to incorporate GEDELT visualizations or create ones using `xts` and `dygraphs`.\n","author":"Nathan Craig","date":"2022-10-10","categories":["how-to","GDELT","wrangling"],"bibliography":["references.bib"]},"extensions":{"book":{"multiFile":true}}}}}